name : 'Validate Code'
description: 'Validation of the pipeline'
runs:
  using: "composite"
  env:
    group: Test
  steps:
  - uses: actions/checkout@v2
  - # "Note: the 'AZURE_SP' secret is required to be added into GitHub Secrets. See this blog post for details: https://samlearnsazure.blog/2019/12/13/github-actions/"
      name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_SP }
  - name: Install Python 3.7
    uses: actions/setup-python@v1
    with:
        python-version: 3.7
  - name: Install pip3
    run: python -m pip install --upgrade pip setuptools wheel
  - name: Install Checkov using pip3
    run: pip3 install checkov
  - name: Security test with Checkov
    run: checkov -d '${{ github.workspace }}' -o junitxml -s >> checkov_sectests.xml
      
  - name: Publish Security Test Results (Checkov)
    uses: EnricoMi/publish-unit-test-result-action@v1
    if: always()
    with:
      files: test-results/**/*.xml   
        
  - name: Terraform Install
    uses: hashicorp/setup-terraform@v1
    with:
        terraform_version: 0.14.11
        
  - name: Terraform Init
    run: terraform init
  - name: Terraform Validate
    run: terraform validate
      
  
